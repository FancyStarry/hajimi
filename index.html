<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµæ„Ÿè‡åŠ å¯†å™¨</title>
    <!-- æ–°å¢çš„å›¾æ ‡é“¾æ¥ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3csvg t='1752421917609' class='icon' viewBox='0 0 1024 1024' version='1.1' xmlns='http://www.w3.org/2000/svg' p-id='1588' width='200' height='200'%3e%3cpath d='M512 1024C230.4 1024 0 793.6 0 512S230.4 0 512 0s512 230.4 512 512-230.4 512-512 512z m0-938.666667C277.333333 85.333333 85.333333 277.333333 85.333333 512s192 426.666667 426.666667 426.666667 426.666667-192 426.666667-426.666667S746.666667 85.333333 512 85.333333z' fill='%23585ce5' p-id='1589'%3e%3c/path%3e%3cpath d='M631.466667 635.733333H768v76.8h-136.533333v76.8h-89.6v-76.8H418.133333v-46.933333c-93.866667 89.6-110.933333 106.666667-119.466666 123.733333v-4.266666c-8.533333-17.066667-29.866667-46.933333-42.666667-55.466667 12.8-12.8 29.866667-38.4 29.866667-72.533333v-166.4H226.133333V409.6h145.066667v200.533333l21.333333-21.333333c8.533333 17.066667 17.066667 42.666667 25.6 59.733333v-12.8h123.733334v-25.6h-102.4v-76.8h102.4v-42.666666h89.6v42.666666h102.4v76.8h-102.4v25.6zM307.2 388.266667c-12.8-29.866667-42.666667-76.8-64-115.2l68.266667-42.666667c21.333333 34.133333 55.466667 81.066667 68.266666 110.933333L307.2 388.266667z m473.6-115.2c-25.6 51.2-64 93.866667-106.666667 132.266666 38.4 12.8 76.8 25.6 123.733334 34.133334-17.066667 17.066667-42.666667 51.2-55.466667 76.8-55.466667-12.8-102.4-34.133333-145.066667-59.733334-51.2 25.6-106.666667 46.933333-162.133333 64-8.533333-21.333333-29.866667-59.733333-46.933333-76.8 46.933333-8.533333 93.866667-25.6 136.533333-42.666666-25.6-25.6-46.933333-51.2-68.266667-81.066667h-38.4V247.466667h290.133334l17.066666-4.266667 55.466667 29.866667z m-234.666667 51.2c12.8 12.8 29.866667 29.866667 46.933334 42.666666 17.066667-12.8 38.4-25.6 51.2-42.666666h-98.133334z' fill='%23585ce5' p-id='1590'%3e%3c/path%3e%3c/svg%3e">
    <style>
        /* CSS (æŠ˜å ) */
        :root { --bg-color: #f0f2f5; --container-bg: #ffffff; --text-color: #333333; --border-color: #dcdfe6; --button-bg: #409eff; --button-text: #ffffff; --button-hover-bg: #66b1ff; --shadow-color: rgba(0, 0, 0, 0.1); --error-color: #f56c6c; --theme-icon: 'â˜€ï¸'; }
        body.dark-mode { --bg-color: #1a1a1a; --container-bg: #2c2c2c; --text-color: #e0e0e0; --border-color: #444444; --button-bg: #585ce5; --button-hover-bg: #797ee8; --shadow-color: rgba(0, 0, 0, 0.3); --error-color: #ff7676; --theme-icon: 'ğŸŒ™'; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; transition: background-color 0.3s, color 0.3s; padding: 20px; }
        .container { width: 100%; max-width: 600px; background-color: var(--container-bg); padding: 25px 30px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); transition: background-color 0.3s; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        h1 { font-size: 24px; color: var(--text-color); }
        #theme-toggle { font-size: 24px; background: none; border: none; cursor: pointer; padding: 5px; }
        #theme-toggle::after { content: var(--theme-icon); }
        .dictionary-section { margin-bottom: 20px; }
        .dictionary-section label { display: block; margin-bottom: 8px; font-weight: bold; }
        .dict-input-wrapper { display: flex; gap: 10px; }
        #custom-dict { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-color); color: var(--text-color); font-size: 16px; min-width: 0; }
        #apply-dict-btn { padding: 0 15px; font-size: 14px; flex-shrink: 0; }
        #dict-error { color: var(--error-color); font-size: 14px; margin-top: 8px; height: 1em; }
        textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-color); color: var(--text-color); font-size: 16px; resize: vertical; margin-bottom: 20px; transition: background-color 0.3s, border-color 0.3s; }
        textarea:focus, #custom-dict:focus { outline: none; border-color: var(--button-bg); box-shadow: 0 0 0 2px color-mix(in srgb, var(--button-bg) 30%, transparent); }
        .buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        button { padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; background-color: var(--button-bg); color: var(--button-text); transition: background-color 0.2s, transform 0.1s; }
        button:hover { background-color: var(--button-hover-bg); }
        button:active { transform: scale(0.98); }
        #copy-btn { grid-column: 1 / -1; background-color: #67c23a; }
        #copy-btn:hover { background-color: #85d861; }
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML ç»“æ„ (æŠ˜å ) -->
        <div class="header"><h1>çµæ„Ÿè‡åŠ å¯†å™¨</h1><button id="theme-toggle" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼"></button></div>
        <div class="dictionary-section"><label for="custom-dict">è‡ªå®šä¹‰åŠ å¯†å­—å…¸ï¼š</label><div class="dict-input-wrapper"><input type="text" id="custom-dict"><button id="apply-dict-btn">åº”ç”¨</button></div><p id="dict-error"></p></div>
        <textarea id="input-text" placeholder="åœ¨æ­¤è¾“å…¥è¦åŠ å¯†æˆ–è§£å¯†çš„æ–‡æœ¬..."></textarea>
        <div class="buttons"><button id="encrypt-btn">åŠ å¯†</button><button id="decrypt-btn">è§£å¯†</button></div>
        <textarea id="output-text" placeholder="ç»“æœå°†æ˜¾ç¤ºåœ¨æ­¤å¤„..." readonly></textarea>
        <button id="copy-btn">å¤åˆ¶ç»“æœ</button>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- æ ¸å¿ƒå¸¸é‡å’Œå˜é‡ ---
    const DEFAULT_GUGU_DICT_STRING = 'çµæ„Ÿè‡å’•å˜å™œåˆ®æ“¦å‘–å“©';
    
    let ENCODING_CHARS = [];
    let SEPARATOR = '';

    // --- DOM å…ƒç´ è·å– (æ— å˜åŒ–) ---
    const inputText = document.getElementById('input-text');
    const outputText = document.getElementById('output-text');
    const encryptBtn = document.getElementById('encrypt-btn');
    const decryptBtn = document.getElementById('decrypt-btn');
    const copyBtn = document.getElementById('copy-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const customDictInput = document.getElementById('custom-dict');
    const applyDictBtn = document.getElementById('apply-dict-btn');
    const dictError = document.getElementById('dict-error');
    
    // --- æ ¸å¿ƒç®—æ³•ï¼šè®¡ç®—åˆ†éš”ç¬¦å¹¶è¿”å›ç¼–ç ç”¨å­—å…¸ ---
    function calculateSeparatorAndChars(fullDict) {
        const checksum = fullDict.reduce((sum, char) => sum + char.charCodeAt(0), 0);
        const separatorIndex = checksum % fullDict.length;
        const separatorChar = fullDict[separatorIndex];
        const encodingChars = fullDict.filter((_, index) => index !== separatorIndex);
        
        return {
            separator: separatorChar,
            chars: encodingChars
        };
    }
    
    // --- åº”ç”¨å­—å…¸çš„å‡½æ•° ---
    function applyDictionary(dictString) {
        dictError.textContent = '';
        if (!dictString || dictString.length < 2) {
            dictError.textContent = 'é”™è¯¯ï¼šå­—å…¸è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦ã€‚';
            return false;
        }
        if (new Set(dictString).size !== dictString.length) {
            dictError.textContent = 'é”™è¯¯ï¼šå­—å…¸ä¸­ä¸èƒ½æœ‰é‡å¤å­—ç¬¦ã€‚';
            return false;
        }
        
        const { separator, chars } = calculateSeparatorAndChars(Array.from(dictString));
        
        SEPARATOR = separator;
        ENCODING_CHARS = chars;
        
        localStorage.setItem('customDictionary', dictString);
        return true;
    }

    // --- åŠ /è§£å¯†é€»è¾‘ ---
    function toBase(n) {
        if (n === 0) return ENCODING_CHARS[0];
        let result = '';
        const base = ENCODING_CHARS.length;
        while (n > 0) {
            result = ENCODING_CHARS[n % base] + result;
            n = Math.floor(n / base);
        }
        return result;
    }

    function fromBase(str) {
        let decimalValue = 0;
        const base = ENCODING_CHARS.length;
        for (let i = 0; i < str.length; i++) {
            const char = str[i];
            const index = ENCODING_CHARS.indexOf(char);
            if (index === -1) {
                throw new Error(`æ— æ•ˆçš„å­—ç¬¦: "${char}"`);
            }
            decimalValue = decimalValue * base + index;
        }
        return decimalValue;
    }

    function encrypt(text) {
        return text.split('').map(char => toBase(char.charCodeAt(0))).join(SEPARATOR);
    }

    function decrypt(guguText) {
        const parts = guguText.split(SEPARATOR);
        try {
            return parts.map(part => {
                if (part === '') return '';
                return String.fromCharCode(fromBase(part));
            }).join('');
        } catch (error) {
            return `è§£å¯†å¤±è´¥ï¼š${error.message}ï¼Œè¯·æ£€æŸ¥å­—å…¸æ˜¯å¦æ­£ç¡®ã€‚`;
        }
    }
    
    // --- äº‹ä»¶ç›‘å¬å™¨ ---
    applyDictBtn.addEventListener('click', () => {
        if (applyDictionary(customDictInput.value)) {
            const originalText = applyDictBtn.innerText;
            applyDictBtn.innerText = 'æˆåŠŸ!';
            setTimeout(() => { applyDictBtn.innerText = originalText; }, 1500);
        }
    });

    encryptBtn.addEventListener('click', () => {
        if (inputText.value) outputText.value = encrypt(inputText.value);
    });
    decryptBtn.addEventListener('click', () => {
        if (inputText.value) outputText.value = decrypt(inputText.value);
    });
    copyBtn.addEventListener('click', () => {
        if (outputText.value) {
            navigator.clipboard.writeText(outputText.value).then(() => {
                const originalText = copyBtn.innerText;
                copyBtn.innerText = 'å·²å¤åˆ¶ï¼';
                setTimeout(() => { copyBtn.innerText = originalText; }, 1500);
            }).catch(err => console.error('å¤åˆ¶å¤±è´¥: ', err));
        }
    });
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });

    // --- åˆå§‹åŒ–å‡½æ•° ---
    function initialize() {
        if (localStorage.getItem('theme') !== 'light') {
            document.body.classList.add('dark-mode');
        }

        const savedDict = localStorage.getItem('customDictionary') || DEFAULT_GUGU_DICT_STRING;
        customDictInput.value = savedDict;
        
        applyDictionary(savedDict);
    }

    // å¯åŠ¨ï¼
    initialize();
});
</script>

</body>
</html>
